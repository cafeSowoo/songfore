<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>커뮤니티 게시판</title>
  <style>
    :root {
      --bg: #f6f8ff;
      --card: #ffffff;
      --line: #d8def4;
      --text: #1b2551;
      --muted: #5f6b99;
      --primary: #3f67ff;
      --ok: #0f8a48;
      --warn: #b06d00;
      --danger: #b3261e;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Pretendard", "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
      color: var(--text);
      background: linear-gradient(180deg, #eef2ff 0%, var(--bg) 60%);
    }

    .container {
      width: min(900px, 94vw);
      margin: 28px auto 56px;
      display: grid;
      gap: 16px;
    }

    .panel {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 14px;
      box-shadow: 0 8px 24px rgba(26, 39, 87, 0.06);
      padding: 16px;
    }

    h1 {
      margin: 0;
      font-size: 1.4rem;
    }

    .sub {
      margin: 6px 0 0;
      color: var(--muted);
      font-size: 0.95rem;
    }

    .post {
      border-top: 1px solid var(--line);
      padding: 12px 0;
    }

    .post:first-of-type {
      border-top: 0;
    }

    .post-title {
      margin: 0;
      font-size: 1rem;
      color: #21306d;
    }

    .post-meta {
      margin: 5px 0 8px;
      font-size: 0.84rem;
      color: var(--muted);
    }

    .post-content {
      margin: 0;
      line-height: 1.45;
      white-space: pre-wrap;
    }

    .post-actions {
      margin-top: 10px;
      display: flex;
      gap: 8px;
    }

    a {
      color: var(--primary);
      text-decoration: none;
      font-weight: 700;
    }

    a:hover {
      text-decoration: underline;
    }

    .actions {
      display: flex;
      gap: 12px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    button {
      border: 0;
      border-radius: 10px;
      padding: 10px 14px;
      font-size: 0.9rem;
      font-weight: 700;
      cursor: pointer;
      color: #fff;
      background: var(--primary);
    }

    button.secondary {
      background: #e9edff;
      color: #2a3a8a;
    }

    .status {
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 10px;
      background: #e9efff;
      color: #2f3f8f;
      font-size: 0.9rem;
    }

    .status.ok {
      background: #e8f8ed;
      color: var(--ok);
    }

    .status.warn {
      background: #fff4e0;
      color: var(--warn);
    }

    .status.error {
      background: #ffe9e9;
      color: var(--danger);
    }

    .empty {
      color: var(--muted);
      margin: 10px 0 0;
    }

    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <main class="container">
    <section class="panel">
      <h1>커뮤니티 게시판</h1>
      <p class="sub">관리자 권한(마스터/운영진)만 글쓰기·수정·삭제가 가능합니다. 글은 Firestore(posts)로 저장됩니다.</p>

      <div class="actions" style="margin-top: 12px;">
        <button id="loginBtn">Google 로그인</button>
        <button id="logoutBtn" class="secondary" type="button">로그아웃</button>
        <button id="writeBtn" class="hidden" type="button">새 글 쓰기</button>
      </div>
      <div id="boardAuthInfo" class="status">로그인 정보를 확인하는 중...</div>

      <div id="board" class="panel" style="margin-top: 12px;"></div>

      <div class="actions" style="margin-top: 12px;">
        <a href="/">홈으로</a>
        <a href="../admin/">관리자 페이지</a>
      </div>
    </section>
  </main>

  <script type="module">
    import {
      initAuthSession,
      loginWithGoogle,
      logout,
      observeAuth,
      getCurrentUserRole,
      handleRedirectLogin,
      ROLE,
      db
    } from '../common/firebase.js';
    import {
      addDoc,
      collection,
      deleteDoc,
      doc,
      onSnapshot,
      orderBy,
      query,
      serverTimestamp,
      updateDoc,
    } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js';

    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const writeBtn = document.getElementById('writeBtn');
    const statusEl = document.getElementById('boardAuthInfo');
    const boardEl = document.getElementById('board');

    const POSTS_COLLECTION = 'posts';

    const state = {
      posts: [],
      canManage: false,
      currentUser: null,
      currentRole: ROLE.NONE,
      unsubPosts: null
    };

    function isManagerRole(role) {
      return role === ROLE.MASTER || role === ROLE.ADMIN;
    }

    function getManagementErrorMessage(error) {
      const code = error?.code || '';
      if (code === 'permission-denied' || code === 'failed-precondition') {
        return '권한이 없습니다. Firebase 규칙 또는 roles 데이터 설정을 확인해주세요.';
      }
      return error?.message || '알 수 없는 오류가 발생했습니다.';
    }

    function assertCanManage(operationLabel) {
      if (!state.currentUser) {
        throw new Error(`${operationLabel}은(는) 로그인 후 이용 가능합니다.`);
      }

      if (!state.canManage) {
        throw new Error(`${operationLabel}은(는) 관리자만 가능합니다.`);
      }
    }

    function setStatus(text, level = 'info') {
      statusEl.textContent = text;
      statusEl.className = `status ${level}`;
    }

    function formatDate(value) {
      if (!value) return '-';

      if (value instanceof Date) {
        return value.toISOString().slice(0, 10);
      }

      const maybeTs = typeof value.toDate === 'function'
        ? value.toDate()
        : null;

      if (maybeTs) {
        return maybeTs.toISOString().slice(0, 10);
      }

      if (typeof value === 'string') {
        return value;
      }

      if (typeof value === 'object' && typeof value.seconds === 'number') {
        return new Date(value.seconds * 1000).toISOString().slice(0, 10);
      }

      return '-';
    }

    function escapeHtml(value) {
      return String(value)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;');
    }

    function render() {
      const posts = state.posts;
      if (!posts.length) {
        boardEl.innerHTML = '<p class="empty">등록된 글이 아직 없습니다.</p>';
        return;
      }

      boardEl.innerHTML = posts
        .map((post) => `
          <article class="post">
            <h2 class="post-title">${escapeHtml(post.title || '제목 없음')}</h2>
            <div class="post-meta">${escapeHtml(post.author || '알 수 없는 작성자')} · ${formatDate(post.createdAt)}</div>
            <p class="post-content">${escapeHtml(post.content || '')}</p>
            <div class="post-actions" data-id="${post.id}">
              ${state.canManage
                ? `<button class="secondary edit-btn" data-id="${post.id}" type="button">수정</button>
                   <button class="delete-btn" data-id="${post.id}" type="button">삭제</button>`
                : ''}
            </div>
          </article>
        `)
        .join('');
    }

    async function refreshAuth() {
      let roleLabel = ROLE.NONE;

      if (!state.currentUser) {
        state.canManage = false;
        writeBtn.classList.add('hidden');
        setStatus('로그인되지 않았습니다. 읽기만 가능합니다.', 'warn');
        render();
        return;
      }

      try {
        const role = await getCurrentUserRole(state.currentUser);
        state.currentRole = role || ROLE.NONE;
        state.canManage = isManagerRole(state.currentRole);
        roleLabel = state.currentRole;
      } catch (error) {
        console.error('사용자 권한 확인 실패:', error);
        state.currentRole = ROLE.NONE;
        state.canManage = false;
        roleLabel = ROLE.NONE;
      }

      if (state.canManage) {
        writeBtn.classList.remove('hidden');
        setStatus(`로그인: ${state.currentUser.email || '-'} / 역할: ${roleLabel}. 글쓰기/수정/삭제 가능`, 'ok');
      } else {
        writeBtn.classList.add('hidden');
        setStatus(`로그인: ${state.currentUser.email || '-'} / 역할: ${roleLabel}. 권한이 없어 관리 기능은 비활성입니다.`, 'warn');
      }

      render();
    }

    function listenPosts() {
      if (state.unsubPosts) {
        state.unsubPosts();
      }

      const postsRef = collection(db, POSTS_COLLECTION);
      const q = query(postsRef, orderBy('createdAt', 'desc'));

      state.unsubPosts = onSnapshot(
        q,
        (snapshot) => {
          state.posts = snapshot.docs.map((docSnapshot) => ({
            id: docSnapshot.id,
            ...docSnapshot.data()
          }));
          render();
        },
        (error) => {
          setStatus(`게시글 불러오기 실패: ${error.message}`, 'error');
          state.posts = [];
          render();
        }
      );
    }

    function makePromptedText(message, fallback) {
      const text = window.prompt(message, fallback || '');
      return text === null ? null : text.trim();
    }

    async function createPost() {
      try {
        assertCanManage('글쓰기');
      } catch (error) {
        setStatus(error.message, 'error');
        return;
      }

      const title = makePromptedText('제목을 입력하세요');
      if (!title) return;

      const content = makePromptedText('내용을 입력하세요', '');
      if (content === null) return;

      try {
        await addDoc(collection(db, POSTS_COLLECTION), {
          title,
          content,
          author: state.currentUser?.email || '관리자',
          authorUid: state.currentUser?.uid || null,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });
        setStatus('글이 작성되었습니다.', 'ok');
      } catch (error) {
        setStatus(`글쓰기 실패: ${getManagementErrorMessage(error)}`, 'error');
      }
    }

    async function updatePost(postId) {
      try {
        assertCanManage('글 수정');
      } catch (error) {
        setStatus(error.message, 'error');
        return;
      }

      const target = state.posts.find((post) => post.id === postId);
      if (!target) return;

      const nextTitle = makePromptedText('수정할 제목', target.title || '');
      if (nextTitle === null) return;
      const nextContent = makePromptedText('수정할 내용', target.content || '');
      if (nextContent === null) return;

      try {
        await updateDoc(doc(db, POSTS_COLLECTION, postId), {
          title: nextTitle,
          content: nextContent,
          updatedAt: serverTimestamp()
        });
        setStatus('글이 수정되었습니다.', 'ok');
      } catch (error) {
        setStatus(`수정 실패: ${getManagementErrorMessage(error)}`, 'error');
      }
    }

    async function removePost(postId) {
      try {
        assertCanManage('글 삭제');
      } catch (error) {
        setStatus(error.message, 'error');
        return;
      }

      const okay = window.confirm('이 글을 삭제할까요?');
      if (!okay) return;

      try {
        await deleteDoc(doc(db, POSTS_COLLECTION, postId));
        setStatus('글이 삭제되었습니다.', 'ok');
      } catch (error) {
        setStatus(`삭제 실패: ${getManagementErrorMessage(error)}`, 'error');
      }
    }

    loginBtn.addEventListener('click', async () => {
      try {
        await loginWithGoogle();
      } catch (error) {
        setStatus(`로그인 실패: ${error.message}`, 'error');
      }
    });

    logoutBtn.addEventListener('click', async () => {
      try {
        await logout();
      } catch (error) {
        setStatus(`로그아웃 실패: ${error.message}`, 'error');
      }
    });

    writeBtn.addEventListener('click', createPost);

    boardEl.addEventListener('click', (event) => {
      if (!state.canManage) return;

      const target = event.target;
      const editBtn = target.closest('.edit-btn');
      const deleteBtn = target.closest('.delete-btn');

      if (editBtn) {
        const postId = editBtn.getAttribute('data-id');
        updatePost(postId);
        return;
      }

      if (deleteBtn) {
        const postId = deleteBtn.getAttribute('data-id');
        removePost(postId);
      }
    });

    observeAuth((user) => {
      state.currentUser = user;
      (async () => {
        try {
          await refreshAuth();
        } catch (error) {
          setStatus(`권한 확인 실패: ${error.message}`, 'error');
        }
      })();
    });

    (async () => {
      try {
        await initAuthSession();
        const redirectResult = await handleRedirectLogin();
        if (redirectResult?.user) {
          setStatus(`로그인 완료: ${redirectResult.user.email || '-'}`, 'ok');
        } else {
          setStatus('Firebase 인증 준비 완료. 로그인 후 새 글 작성/수정/삭제 권한을 확인합니다.', 'ok');
        }
      } catch (error) {
        setStatus(`Firebase 초기화 실패: ${error.message}`, 'error');
      }

      listenPosts();
      refreshAuth();
    })();
  </script>
</body>
</html>
